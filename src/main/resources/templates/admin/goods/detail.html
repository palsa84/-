<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
    <link rel="stylesheet" th:href="@{/css/custom.css}">
    <title th:text="|상품 상세 (관리자): ${goods.goodsTitle}|">상품 상세</title>
</head>
<body>

<div th:replace="~{admin/include/adminHeader.html :: adminHeader}"></div>

<div class="container my-5">
    <div class="row">

        <div class="col-md-4">
            <img th:src="@{|/upload/${goods.storedFileName}|}"
                 class="img-fluid"
                 th:alt="${goods.goodsTitle}"
                 style="width: 80%; height: auto;">
        </div>

        <div class="col-md-8">
            <h2 th:text="${goods.goodsTitle}">상품 제목</h2>
            <h4 class="text-danger" th:text="|${goods.goodsCost} 원|"></h4>

            <p th:utext="${goods.goodsContents}" style="white-space: pre-wrap; max-height: 100px; overflow: hidden;">상품 설명</p>

            <div class="mt-4 text-right">
                <a th:href="@{/admin/goods/list}" class="btn btn-secondary">목록</a>
                <a th:href="@{/admin/goods/edit/{id} (id=${goods.id})}" class="btn btn-warning ml-2">수정</a>
                <a th:href="@{/admin/goods/delete/{id}(id=${goods.id})}" class="btn btn-danger ml-2"
                   onclick="return confirm('정말 삭제하시겠습니까?');">삭제</a>
            </div>
        </div>
    </div>

    <div class="row mt-5">
        <div class="col-12">
            <ul class="nav nav-tabs" id="productTab" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="description-tab" data-toggle="tab" href="#description"
                       role="tab" aria-controls="description" aria-selected="true"> 상품 상세 설명</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="review-tab" data-toggle="tab" href="#reviews" role="tab"
                       aria-controls="reviews" aria-selected="false">댓글</a>
                </li>
            </ul>

            <div class="tab-content" id="productTabContent">

                <div class="tab-pane fade show active p-4 border border-top-0" id="description" role="tabpanel"
                     aria-labelledby="description-tab">

                    <div class="product-description-content" th:utext="${goods.goodsContents}">
                    </div>
                </div>

                <div class="tab-pane fade p-4 border border-top-0" id="reviews" role="tabpanel" aria-labelledby="review-tab">

                    <div class="mb-4 p-3 border rounded">
                        <h5>댓글 작성</h5>
                        <div class="form-row">
                            <div class="col-md-3 mb-2">
                                <input type="text" id="commentWriter" class="form-control" placeholder="작성자">
                            </div>
                            <div class="col-md-7 mb-2">
                                <input type="text" id="commentContents" class="form-control" placeholder="댓글 내용을 입력하세요">
                            </div>
                            <div class="col-md-2 mb-2">
                                <button type="button" class="btn btn-sm btn-info btn-block" onclick="commentWrite()">등록</button>
                            </div>
                        </div>
                    </div>

                    <div id="comment-list-area">
                        <h5 class="mt-4 mb-3">댓글 목록</h5>
                        <table class="table table-bordered">
                            <thead class="thead-light">
                            <tr>
                                <th style="width: 10%;">번호</th>
                                <th style="width: 20%;">작성자</th>
                                <th style="width: 50%;">내용</th>
                                <th style="width: 20%;">등록일</th>
                            </tr>
                            </thead>
                            <tbody id="comment-list">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2R2+Wn4T/sszGgdaJsk9lqE55xH4Zk2yC0fC2aC1DkX7y6g0P4o4" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js" integrity="sha384-7u8GK99o3T9L7sLqG0sFf4kKqgP2LwE5/3p5tB1Ff6n6G8/1QJ/g/8" crossorigin="anonymous"></script>
<script th:inline="javascript">
    const goodsId = [[${goods.id}]];

    // 1. 댓글 목록을 화면에 그려주는 함수 (HTML 테이블 생성)
    const displayCommentList = (commentList) => {
        const $commentTableBody = $('#comment-list'); // jQuery 사용
        $commentTableBody.empty(); // 기존 목록 삭제

        if (commentList && commentList.length > 0) {
            commentList.forEach((comment, index) => {
                // 댓글 번호를 최신순으로 표시 (총 개수 - 현재 인덱스)
                const commentNo = commentList.length - index;

                // LocalDateTime을 yyyy-MM-dd HH:mm 형식으로 표시 (서버에서 JSON 직렬화된 문자열을 가정)
                const formattedTime = comment.createdTime ? comment.createdTime.substring(0, 16).replace('T', ' ') : '-';

                const row = `
                    <tr>
                        <td>${commentNo}</td>
                        <td>${comment.commentWriter}</td>
                        <td>${comment.commentContents}</td>
                        <td>${formattedTime}</td>
                    </tr>
                `;
                $commentTableBody.append(row);
            });
        } else {
             const row = `
                <tr>
                    <td colspan="4" class="text-center">등록된 댓글이 없습니다.</td>
                </tr>
            `;
            $commentTableBody.append(row);
        }
    }

    // 2. 초기 댓글 목록 로드 함수
    const findAllComment = () => {
        if (!goodsId) {
            console.error("상품 ID가 유효하지 않아 댓글을 로드할 수 없습니다.");
            return;
        }

        $.ajax({
            type: "get",
            url: `/comment/list/${goodsId}`,
            success: function(res) {
                displayCommentList(res);
            },
            error: function(err) {
                console.log("댓글 목록 로드 실패", err);
            }
        });
    }

    // 3. 댓글 작성 및 등록 처리 함수 (버튼 클릭 시 호출)
    const commentWrite = () => {
        const writer = document.getElementById("commentWriter").value;
        const contents = document.getElementById("commentContents").value;

        if (!writer.trim() || !contents.trim()) {
            alert("작성자와 내용을 모두 입력해주세요.");
            return;
        }

        $.ajax({
            type: "post",
            url: "/comment/save", // 댓글 저장 서버 경로
            data: {
                "commentWriter": writer,
                "commentContents": contents,
                "goodsId": goodsId
            },
            success: function(res) {
                displayCommentList(res);

                // 입력창 초기화
                document.getElementById("commentWriter").value = '';
                document.getElementById("commentContents").value = '';
            },
            error: function(err) {
                console.log("댓글 저장 실패", err);
                alert("댓글 저장에 실패했습니다. (서버 로그 확인 필요)");
            }
        });
    }

    // Query 준비 이벤트 발생 시 바로 댓글 목록 로드
    $(document).ready(function() {
        findAllComment();
    });

</script>
</body>
</html>