<!--templates/goods/detail.html (ì‚¬ìš©ì)-->
<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" xintegrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
    <link rel="stylesheet" th:href="@{/css/custom.css}">
    <title th:text="${goods.goodsTitle}">ìƒí’ˆ ìƒì„¸</title>
</head>
<body>

<div th:replace="~{include/header.html :: header}"></div>


<div class="container my-5">
    <div class="row">

        <div class="col-md-4">
            <img th:src="@{|/upload/${goods.storedFileName}|}"
                 class="img-fluid"
                 th:alt="${goods.goodsTitle}"
                 style="width: 80%; height: auto;">
        </div>

        <div class="col-md-8">
            <h2 th:text="${goods.goodsTitle}">ìƒí’ˆ ì œëª©</h2>
            <h4 class="text-danger" th:text="|${goods.goodsCost} ì›|"></h4>


            <p th:utext="${goods.goodsContents}" style="white-space: pre-wrap;">ìƒí’ˆ ì„¤ëª…</p>

            <div class="form-group">
                <label for="quantity">ìˆ˜ëŸ‰</label>
                <input type="number" id="quantity" class="form-control w-25" value="1" min="1">
            </div>
            <a  href="" class="btn btn-primary btn-lg mr-2">ì°œí•˜ê¸°</a>
            <a href="" class="btn btn-success btn-lg">êµ¬ë§¤í•˜ê¸°</a>

            <p class="mt-3 text-muted" th:text="|ì¡°íšŒìˆ˜ : ${goods.goodsHits}|">ì¡°íšŒìˆ˜ : 0</p>

            <div class="mt-4">
                <a th:href="@{/goods}" class="btn btn-secondary">ëª©ë¡</a>
            </div>
        </div>
    </div>
    <div class="row mt-5">
        <div class="col-12">
            <ul class="nav nav-tabs" id="productTab" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="description-tab" data-toggle="tab" href="#description"
                       role="tab" aria-controls="description" aria-selected="true"> ìƒí’ˆ ìƒì„¸ ì„¤ëª…</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="review-tab" data-toggle="tab" href="#reviews" role="tab"
                       aria-controls="reviews" aria-selected="false">ëŒ“ê¸€</a>
                </li>
            </ul>

            <div class="tab-content" id="productTabContent">

                <div class="tab-pane fade show active p-4 border border-top-0" id="description" role="tabpanel"
                     aria-labelledby="description-tab">

                    <div class="product-description-content" th:utext="${goods.goodsContents}">
                    </div>
                </div>

                <div class="tab-pane fade p-4 border border-top-0" id="reviews" role="tabpanel" aria-labelledby="review-tab">

                    <div class="mb-4 p-3 border rounded">
                        <h5>ëŒ“ê¸€ ì‘ì„±</h5>
                        <div class="form-row">
                            <div class="col-md-3 mb-2">
                                <input type="text" id="commentWriter" class="form-control" placeholder="ì‘ì„±ì">
                            </div>
                            <div class="col-md-7 mb-2">
                                <input type="text" id="commentContents" class="form-control" placeholder="ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”">
                            </div>
                            <div class="col-md-2 mb-2">
                                <button type="button" class="btn btn-sm btn-info btn-block" onclick="commentWrite()">ë“±ë¡</button>
                            </div>
                        </div>
                    </div>

                    <div id="comment-list-area">
                        <h5 class="mt-4 mb-3">ëŒ“ê¸€ ëª©ë¡</h5>
                        <table class="table table-bordered">
                            <thead class="thead-light">
                            <tr>
                                <th style="width: 10%;">ë²ˆí˜¸</th>
                                <th style="width: 20%;">ì‘ì„±ì</th>
                                <th style="width: 50%;">ë‚´ìš©</th>
                                <th style="width: 20%;">ë“±ë¡ì¼</th>
                            </tr>
                            </thead>
                            <tbody id="comment-list">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" xintegrity="sha384-9/reFTGAW83EW2R2+Wn4T/sszGgdaJsk9lqE55xH4Zk2yC0fC2aC1DkX7y6g0P4o4" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js" xintegrity="sha384-7u8GK99o3T9L7sLqG0sFf4kKqgP2LwE5/3p5tB1Ff6n6G8/1QJ/g/8" crossorigin="anonymous"></script>
<script th:inline="javascript">
    const goodsId = [[${goods.id}]];

    // 1. ëŒ“ê¸€ ëª©ë¡ì„ í™”ë©´ì— ê·¸ë ¤ì£¼ëŠ” í•¨ìˆ˜ (HTML í…Œì´ë¸” ìƒì„±)
                            const displayCommentList = (commentList) => {
                            const $commentTableBody = $('#comment-list'); // jQuery ì‚¬ìš©
                            $commentTableBody.empty(); // ê¸°ì¡´ ëª©ë¡ ì‚­ì œ

                            if (commentList && commentList.length > 0) {
                                commentList.forEach((comment, index) => {
                                    // ëŒ“ê¸€ ë²ˆí˜¸ë¥¼ ìµœì‹ ìˆœìœ¼ë¡œ í‘œì‹œ (ì´ ê°œìˆ˜ - í˜„ì¬ ì¸ë±ìŠ¤)
                                    const commentNo = commentList.length - index;

                                    // LocalDateTimeì„ yyyy-MM-dd HH:mm í˜•ì‹ìœ¼ë¡œ í‘œì‹œ (ì„œë²„ì—ì„œ JSON ì§ë ¬í™”ëœ ë¬¸ìì—´ì„ ê°€ì •)
                                    const formattedTime = comment.createdTime ? comment.createdTime.substring(0, 16).replace('T', ' ') : '-';

                                    const row = `
                                        <tr>
                                            <td>${commentNo}</td>
                                            <td>${comment.commentWriter}</td>
                                            <td>${comment.commentContents}</td>
                                            <td>${formattedTime}</td>
                                        </tr>
                                    `;
                                    $commentTableBody.append(row);
                                });
                            } else {
                                 const row = `
                                    <tr>
                                        <td colspan="4" class="text-center">ë“±ë¡ëœ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</td>
                                    </tr>
                                `;
                                // ğŸŒŸ ìˆ˜ì •ëœ ë¶€ë¶„: ëŒ“ê¸€ì´ ì—†ì„ ë•Œ ìƒì„±í•œ rowë¥¼ í…Œì´ë¸”ì— ì¶”ê°€í•©ë‹ˆë‹¤.
                                $commentTableBody.append(row);
                            }
                        }

    // 2. ì´ˆê¸° ëŒ“ê¸€ ëª©ë¡ ë¡œë“œ í•¨ìˆ˜
    // ì´ í•¨ìˆ˜ëŠ” í˜ì´ì§€ ë¡œë“œ ì‹œ ë°”ë¡œ í˜¸ì¶œë©ë‹ˆë‹¤.
    const findAllComment = () => {
        console.log("ì´ˆê¸° ëŒ“ê¸€ ëª©ë¡ ë¡œë“œ ì‹œì‘");
        // ìƒí’ˆ IDê°€ ìœ íš¨í•œ ê²½ìš°ì—ë§Œ AJAX í˜¸ì¶œ
        if (!goodsId) {
            console.error("ìƒí’ˆ IDê°€ ìœ íš¨í•˜ì§€ ì•Šì•„ ëŒ“ê¸€ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        $.ajax({
            type: "get",
            // ì„œë²„ì˜ CommentControllerì˜ /comment/list/{goodsId} ê²½ë¡œ í˜¸ì¶œ
            url: `/comment/list/${goodsId}`,
            success: function(res) {
                console.log("ëŒ“ê¸€ ëª©ë¡ ë¡œë“œ ì„±ê³µ", res);
                displayCommentList(res);
            },
            error: function(err) {
                console.log("ëŒ“ê¸€ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨", err);
            }
        });
    }

    // 3. ëŒ“ê¸€ ì‘ì„± ë° ë“±ë¡ ì²˜ë¦¬ í•¨ìˆ˜ (ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œ)
    const commentWrite = () => {
        // ì˜¤íƒ€ ìˆ˜ì •: getElementById, valueë¥¼ ì •í™•íˆ ì‚¬ìš©
        const writer = document.getElementById("commentWriter").value;
        const contents = document.getElementById("commentContents").value;

        // ì…ë ¥ê°’ ìœ íš¨ì„± ê²€ì‚¬
        if (!writer.trim() || !contents.trim()) {
            alert("ì‘ì„±ìì™€ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        $.ajax({
            type: "post",
            url: "/comment/save", // ëŒ“ê¸€ ì €ì¥ ì„œë²„ ê²½ë¡œ
            data: {
                "commentWriter": writer,
                "commentContents": contents,
                "goodsId": goodsId
            },
            success: function(res) {
                console.log("ëŒ“ê¸€ ì €ì¥ ì„±ê³µ ë° ëª©ë¡ ê°±ì‹ ", res);

                // ì„œë²„ì—ì„œ ê°±ì‹ ëœ ëª©ë¡(JSON List)ì„ ë°›ì•„ í™”ë©´ ì—…ë°ì´íŠ¸
                displayCommentList(res);

                // ì…ë ¥ì°½ ì´ˆê¸°í™”
                document.getElementById("commentWriter").value = '';
                document.getElementById("commentContents").value = '';
            },
            error: function(err) {
                console.log("ëŒ“ê¸€ ì €ì¥ ì‹¤íŒ¨", err);
                alert("ëŒ“ê¸€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ì„œë²„ ë¡œê·¸ í™•ì¸ í•„ìš”)");
            }
        });
    }

    // Query ì¤€ë¹„ ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ë°”ë¡œ ëŒ“ê¸€ ëª©ë¡ ë¡œë“œ
    $(document).ready(function() {
        findAllComment();

        // ë¶€íŠ¸ìŠ¤íŠ¸ë© íƒ­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ëŠ” ì œê±°í•˜ê±°ë‚˜ ì£¼ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
        // íƒ­ í´ë¦­ ì‹œ ëª©ë¡ ê°±ì‹ ì„ ì›í•˜ì§€ ì•Šìœ¼ë©´ ì´ ë¶€ë¶„ì€ ì£¼ì„ì²˜ë¦¬í•˜ê±°ë‚˜ ì œê±°í•©ë‹ˆë‹¤.
        // $('#review-tab').on('shown.bs.tab', function (e) {
        //     findAllComment();
        // });
    });

</script>
</body>
</html>
