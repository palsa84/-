<!--goods/write.html-->

<!doctype html>
<html lang="en">
<head>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" xintegrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">

  <link rel="stylesheet" th:href="@{/css/custom.css?v=1.0.0}">

  <script src="https://cdn.ckeditor.com/4.22.1/standard/ckeditor.js"></script>
  <title></title>
</head>
<body>
<div th:replace="~{include/header.html :: header}"></div>

<div class="form-container-custom">

  <h3>회원가입</h3>
  <form method="post" action="/member/save" onsubmit="return validateForm()">
    <div class="form-group">
      <label for="userId">아이디</label>
      <input type="text" class="form-control" id="userId" placeholder="아이디를 입력하세요" required
             name="userId" onblur="idCheck()">
      <small id="check-result" class="form-text"></small>
    </div>
    <div class="form-group">
      <label for="userPass">비밀번호</label>
      <input type="password" class="form-control" id="userPass" placeholder="비밀번호를 입력하세요" required
             name="userPass" >
    </div>
    <div class="form-group">
      <label for="userName">이름</label>
      <input type="text" class="form-control" id="userName" placeholder="이름을 입력하세요" required
             name="userName">
    </div>

    <button type="submit"  class="btn btn-info btn-lg btn-block">회원가입</button>

  </form>

</div>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" xintegrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct" crossorigin="anonymous"></script>

<script>
  // 1. 전역 변수로 중복 확인 상태를 저장하는 변수 선언
  let isIdChecked = false; // 중복 확인을 했는지 (필수)
  let isIdAvailable = false; // 아이디가 사용 가능한지

  // 2. 아이디 중복 확인 함수 (onblur, async: false 적용)
  function idCheck() {
      const userId = document.getElementById("userId").value;
      const checkResult = document.getElementById("check-result");

      // 아이디 입력칸에 변화가 있을 때마다 상태 초기화
      isIdChecked = false;
      isIdAvailable = false;

      if (userId.length === 0) {
          checkResult.textContent = "";
          return;
      }

      $.ajax({
          type: "post",
          url: "/member/idcheck",
          data: { "userId": userId },
          // !!! 핵심 수정: async: false 로 동기식 호출 (서버 응답 기다림)
          async: false,
          success: function(res) {
              if (res === "ok") {
                  // 사용 가능
                  checkResult.textContent = "사용 가능한 아이디입니다.";
                  checkResult.style.color = "green";
                  isIdAvailable = true; // 사용 가능 상태 업데이트
              } else {
                  // 중복
                  checkResult.textContent = "사용중인 아이디입니다.";
                  checkResult.style.color = "red";
                  isIdAvailable = false; // 사용 불가 상태 업데이트
              }
              isIdChecked = true; // 확인 완료 상태 업데이트
          },
          error: function(err) {
              console.log("에러 발생", err);
              isIdChecked = true;
              isIdAvailable = false;
          }
      });
  }

  // 3. 폼 제출 시 중복 확인 여부를 체크하는 함수 (onsubmit="return validateForm()")
  function validateForm() {
      const userId = document.getElementById("userId").value;

      // 아이디 입력 필드가 비어있으면 HTML 기본 검사에 맡기고 제출 허용
      if (userId.length === 0) {
          return true;
      }

      // 중복 확인이 완료되지 않았다면 (또는 아이디 입력 후 바로 버튼을 누른 경우)
      // idCheck()를 강제로 호출하여 동기적으로 결과를 받습니다.
      if (!isIdChecked) {
          idCheck();
      }

      // idCheck() 실행 후 최종 상태 확인
      if (!isIdAvailable) {
          // 중복된 아이디인 경우 (이전에 "아이디 중복 확인을 해주세요." 떴던 부분)
          alert("이미 사용 중인 아이디입니다. 다른 아이디를 사용해주세요.");
          return false; // 폼 제출 막기
      }

      // 모든 검사 통과: 폼 제출 허용
      return true;
  }
</script>

</body>
</html>
